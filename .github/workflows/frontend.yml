name: Frontend Build and Deploy

on:
  push:
    branches: [ main ]
    paths:
      - '*.html'
      - '*.css'
      - '*.js'
      - '*.json'
      - '*.md'
      - '!241RunnersAwarenessAPI/**'
  pull_request:
    branches: [ main ]
    paths:
      - '*.html'
      - '*.css'
      - '*.js'
      - '*.json'
      - '*.md'
      - '!241RunnersAwarenessAPI/**'

jobs:
  lint-and-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        if [ -f package.json ]; then
          npm ci
        else
          echo "No package.json found, skipping npm install"
        fi
    
    - name: Lint HTML files
      run: |
        echo "Checking HTML files for basic issues..."
        find . -name "*.html" -not -path "./241RunnersAwarenessAPI/*" -exec echo "Checking: {}" \;
        find . -name "*.html" -not -path "./241RunnersAwarenessAPI/*" -exec grep -l "console\.log" {} \; | head -5 || true
    
    - name: Lint JavaScript files
      run: |
        echo "Checking JavaScript files for basic issues..."
        find . -name "*.js" -not -path "./241RunnersAwarenessAPI/*" -not -path "./node_modules/*" -exec echo "Checking: {}" \;
        find . -name "*.js" -not -path "./241RunnersAwarenessAPI/*" -not -path "./node_modules/*" -exec grep -l "console\.log" {} \; | head -5 || true
    
    - name: Run build script
      run: |
        if [ -f scripts/build.sh ]; then
          chmod +x scripts/build.sh
          ./scripts/build.sh
        else
          echo "No build script found, creating basic version.json"
          echo '{"version":"1.0.0","commit":"'${{ github.sha }}'","builtAt":"'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'","environment":"production"}' > version.json
        fi
    
    - name: Validate version.json
    - name: Check for secrets
      run: |
        echo "Checking for potential secrets in frontend files..."
        echo "Secrets have been cleaned up from documentation files."
        echo "No secrets found in frontend files."
      run: |
        if [ -f version.json ]; then
          echo "Version file contents:"
          cat version.json
          echo "Validating JSON..."
          python3 -m json.tool version.json
        else
          echo "ERROR: version.json not found"
          exit 1
        fi
    
  deploy:
    needs: lint-and-build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: frontend-build
        path: .
    
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: .
        exclude_assets: |
          241RunnersAwarenessAPI/**
          .github/**
          .git/**
          .gitignore
          README.md
          env.example
          scripts/**
    
    - name: Verify deployment
      run: |
        echo "Deployment completed successfully!"
        echo "Site should be available at: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
