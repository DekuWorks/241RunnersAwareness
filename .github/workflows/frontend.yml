name: Frontend CI/CD

on:
  push:
    branches: [ main ]
    paths:
      - '*.html'
      - '*.js'
      - '*.css'
      - 'assets/**'
      - 'admin/**'
      - 'js/**'
      - 'scripts/**'
      - '!241RunnersAwarenessAPI/**'
  pull_request:
    branches: [ main ]
    paths:
      - '*.html'
      - '*.js'
      - '*.css'
      - 'assets/**'
      - 'admin/**'
      - 'js/**'
      - 'scripts/**'
      - '!241RunnersAwarenessAPI/**'

jobs:
  lint-and-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        npm install -g htmlhint
        npm install -g eslint
        npm install -g csslint
    
    - name: Lint HTML files
      run: |
        find . -name "*.html" -not -path "./241RunnersAwarenessAPI/*" -not -path "./.git/*" | xargs htmlhint
    
    - name: Lint JavaScript files
      run: |
        find . -name "*.js" -not -path "./241RunnersAwarenessAPI/*" -not -path "./.git/*" -not -path "./node_modules/*" | xargs eslint --no-eslintrc --env browser,es6 --parser-options ecmaVersion:2020,sourceType:module
    
    - name: Lint CSS files
      run: |
        find . -name "*.css" -not -path "./241RunnersAwarenessAPI/*" -not -path "./.git/*" | xargs csslint --quiet
    
    - name: Run build script
      run: |
        chmod +x scripts/build.sh
        ./scripts/build.sh
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build
        path: dist/
        retention-days: 7
    
    - name: Update version file
      run: |
        # Get current commit hash
        COMMIT_HASH=$(git rev-parse --short HEAD)
        BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")
        BUILD_NUMBER=$(date +"%Y%m%d-%H%M")
        
        # Update version.json
        cat > version.json << VERSION_EOF
        {
          "version": "1.0.0",
          "build": "$BUILD_NUMBER",
          "commit": "$COMMIT_HASH",
          "builtAt": "$BUILD_TIME",
          "environment": "production",
          "apiVersion": "2.0.0"
        }
        VERSION_EOF
        
        echo "Version updated: $BUILD_NUMBER"
    
    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./dist
        cname: 241runnersawareness.org
        keep_files: false
