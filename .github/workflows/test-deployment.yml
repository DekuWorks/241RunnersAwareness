name: Test Deployment and API

on:
  workflow_run:
    workflows: ["Deploy Backend to Azure", "Deploy to GitHub Pages"]
    types: [completed]
  workflow_dispatch:

jobs:
  test-deployment:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Wait for deployment
      run: |
        echo "Waiting for deployment to complete..."
        sleep 60
        
    - name: Test API Health
      run: |
        echo "Testing API health endpoint..."
        response=$(curl -s -o /dev/null -w "%{http_code}" https://241runnersawareness-api.azurewebsites.net/api/auth/health)
        if [ "$response" = "200" ]; then
          echo "‚úÖ API health check passed"
        else
          echo "‚ùå API health check failed: $response"
          exit 1
        fi
        
    - name: Test Admin Login
      run: |
        echo "Testing admin login..."
        response=$(curl -s -X POST "https://241runnersawareness-api.azurewebsites.net/api/auth/login" \
          -H "Content-Type: application/json" \
          -d '{"email":"dekuworks1@gmail.com","password":"NewAdmin123!@"}' \
          -o /dev/null -w "%{http_code}")
        if [ "$response" = "200" ]; then
          echo "‚úÖ Admin login test passed"
        else
          echo "‚ùå Admin login test failed: $response"
          exit 1
        fi
        
    - name: Test Static Site
      run: |
        echo "Testing static site..."
        response=$(curl -s -o /dev/null -w "%{http_code}" https://dekuworks.github.io/241RunnersAwareness/)
        if [ "$response" = "200" ]; then
          echo "‚úÖ Static site test passed"
        else
          echo "‚ùå Static site test failed: $response"
          exit 1
        fi
        
    - name: Test Admin Dashboard
      run: |
        echo "Testing admin dashboard..."
        response=$(curl -s -o /dev/null -w "%{http_code}" https://dekuworks.github.io/241RunnersAwareness/admin/login.html)
        if [ "$response" = "200" ]; then
          echo "‚úÖ Admin dashboard test passed"
        else
          echo "‚ùå Admin dashboard test failed: $response"
          exit 1
        fi
        
    - name: Test Cases Page
      run: |
        echo "Testing cases page..."
        response=$(curl -s -o /dev/null -w "%{http_code}" https://dekuworks.github.io/241RunnersAwareness/cases.html)
        if [ "$response" = "200" ]; then
          echo "‚úÖ Cases page test passed"
        else
          echo "‚ùå Cases page test failed: $response"
          exit 1
        fi
        
    - name: Deployment Summary
      run: |
        echo "üéâ All deployment tests passed!"
        echo "‚úÖ API: https://241runnersawareness-api.azurewebsites.net"
        echo "‚úÖ Static Site: https://dekuworks.github.io/241RunnersAwareness"
        echo "‚úÖ Admin Dashboard: https://dekuworks.github.io/241RunnersAwareness/admin/"
        echo "‚úÖ Cases Page: https://dekuworks.github.io/241RunnersAwareness/cases.html" 