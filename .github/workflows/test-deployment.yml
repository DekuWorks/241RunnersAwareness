name: Test Deployment and API

on:
  workflow_run:
    workflows: ["Deploy Backend to Azure", "Deploy to GitHub Pages"]
    types: [completed]
  workflow_dispatch:

jobs:
  test-deployment:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Wait for deployment
      run: |
        echo "Waiting for deployment to complete..."
        sleep 60
        
    - name: Test API Health
      run: |
        echo "Testing API health endpoint..."
        response=$(curl -s -o /dev/null -w "%{http_code}" https://241runners-api.azurewebsites.net/api/Auth/health)
        if [ "$response" = "200" ]; then
          echo "âœ… API health check passed"
        else
          echo "âŒ API health check failed: $response"
          exit 1
        fi
        
    - name: Test Admin Login
      run: |
        echo "Testing admin login..."
        response=$(curl -s -X POST "https://241runners-api.azurewebsites.net/api/Auth/login" \
          -H "Content-Type: application/json" \
          -H "X-Client: 241RA-Admin/1.0" \
          -d '{"email":"dekuworks1@gmail.com","password":"marcus2025"}' \
          -o /dev/null -w "%{http_code}")
        if [ "$response" = "200" ]; then
          echo "âœ… Admin login test passed"
        else
          echo "âŒ Admin login test failed: $response"
          exit 1
        fi
        
    - name: Test Static Site
      run: |
        echo "Testing static site..."
        response=$(curl -s -o /dev/null -w "%{http_code}" https://241runnersawareness.org/)
        if [ "$response" = "200" ]; then
          echo "âœ… Static site test passed"
        else
          echo "âŒ Static site test failed: $response"
          exit 1
        fi
        
    - name: Test Admin Dashboard
      run: |
        echo "Testing admin dashboard..."
        response=$(curl -s -o /dev/null -w "%{http_code}" https://241runnersawareness.org/admin/login.html)
        if [ "$response" = "200" ]; then
          echo "âœ… Admin dashboard test passed"
        else
          echo "âŒ Admin dashboard test failed: $response"
          exit 1
        fi
        
    - name: Test Cases Page
      run: |
        echo "Testing cases page..."
        response=$(curl -s -o /dev/null -w "%{http_code}" https://241runnersawareness.org/cases.html)
        if [ "$response" = "200" ]; then
          echo "âœ… Cases page test passed"
        else
          echo "âŒ Cases page test failed: $response"
          exit 1
        fi
        
    - name: Deployment Summary
      run: |
        echo "ğŸ‰ All deployment tests passed!"
        echo "âœ… API: https://241runners-api.azurewebsites.net"
        echo "âœ… Static Site: https://241runnersawareness.org"
        echo "âœ… Admin Dashboard: https://241runnersawareness.org/admin/"
        echo "âœ… Cases Page: https://241runnersawareness.org/cases.html"
