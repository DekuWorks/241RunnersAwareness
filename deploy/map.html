<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Map - 241 Runners Awareness</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link rel="stylesheet" href="styles.css?v=20250905" />
    <script src="assets/js/config.js?v=20250905"></script>
    <script src="assets/js/api-utils.js"></script>
    <style>
        /* Enhanced Map Styles */
        #map {
            height: 75vh;
            width: 100%;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            z-index: 1;
        }
        
        .map-container {
            position: relative;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .map-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
            align-items: center;
            justify-content: center;
            padding: 25px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .map-controls button {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .map-controls button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
            background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%);
        }
        
        .secondary-btn {
            background: linear-gradient(135deg, #374151 0%, #1f2937 100%) !important;
            box-shadow: 0 4px 15px rgba(55, 65, 81, 0.3) !important;
        }
        
        .secondary-btn:hover {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%) !important;
            box-shadow: 0 6px 20px rgba(55, 65, 81, 0.4) !important;
        }
        
        /* Report Runner Button */
        .report-runner-btn {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%) !important;
            color: white !important;
            font-weight: bold !important;
            padding: 12px 24px !important;
            border-radius: 25px !important;
            text-decoration: none !important;
            transition: all 0.3s ease !important;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3) !important;
            border: 2px solid transparent !important;
            cursor: pointer !important;
        }

        .report-runner-btn:hover {
            background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%) !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4) !important;
            color: white !important;
        }

        .report-runner-btn:focus {
            outline: 3px solid rgba(220, 38, 38, 0.3) !important;
            outline-offset: 2px !important;
        }
        
        .map-controls select, .map-controls input {
            padding: 12px 20px;
            border: 2px solid #e1e5e9;
            border-radius: 25px;
            background: white;
            color: #333;
            font-weight: 500;
            cursor: pointer;
            transition: border-color 0.3s;
            min-width: 150px;
        }
        
        .map-controls select:focus, .map-controls input:focus {
            outline: none;
            border-color: #dc2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }
        
        .search-box {
            position: relative;
            flex: 1;
        }
        
        .search-box input {
            width: 100%;
            padding-right: 40px;
        }
        
        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            pointer-events: none;
        }
        
        /* Enhanced Popup Styles */
        .runner-popup {
            text-align: left;
            padding: 15px;
            max-width: 300px;
        }
        
        .runner-popup h3 {
            margin: 0 0 15px 0;
            color: #dc2626;
            font-size: 1.3rem;
            border-bottom: 2px solid #f3f4f6;
            padding-bottom: 8px;
        }
        
        .runner-popup .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin: 10px 0;
        }
        
        .runner-popup .info-item {
            display: flex;
            flex-direction: column;
        }
        
        .runner-popup .info-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }
        
        .runner-popup .info-value {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }
        
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 5px 0;
        }
        
        .status-missing { background: #f59e0b; color: white; }
        .status-found { background: #dc2626; color: white; }
        .status-safe { background: #10b981; color: white; }
        .status-deceased { background: #6b7280; color: white; }
        .status-resolved_pending_verify { background: #8b5cf6; color: white; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Loading and Error States */
        .loading {
            text-align: center;
            padding: 60px;
            color: #666;
            font-size: 1.1rem;
        }
        
        .error {
            background: #dc2626;
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
        }
        
        .no-data {
            text-align: center;
            padding: 60px;
            color: #666;
            font-style: italic;
            font-size: 1.1rem;
        }

        /* Enhanced Info Panel */
        .map-info {
            margin-top: 30px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .map-info h3 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.4rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #e5e7eb;
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            color: #dc2626;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Real-time indicator */
        .realtime-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(16, 185, 129, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .realtime-indicator::before {
            content: '';
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        /* Dark mode adjustments */
        body.dark-mode #map {
            filter: brightness(0.8) contrast(1.2);
        }

        body.dark-mode .map-container {
            background: #1f2937;
        }

        body.dark-mode .map-info {
            background: rgba(31, 41, 55, 0.95);
            color: #fff;
        }

        body.dark-mode .map-info h3 {
            color: #fff;
        }

        body.dark-mode .legend-item,
        body.dark-mode .stat-card {
            background: #374151;
            color: #fff;
            border-color: #4b5563;
        }

        body.dark-mode .map-controls select,
        body.dark-mode .map-controls input {
            background: #374151;
            color: #fff;
            border-color: #4b5563;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .map-controls {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .control-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .map-controls button,
            .map-controls select,
            .map-controls input {
                width: 100%;
            }
            
            #map {
                height: 60vh;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <header role="banner">
        <div class="header-bar">
            <img src="assets/images/241-logo.jpg" alt="241 Runners Awareness Logo - Supporting missing and vulnerable individuals" class="logo" />
            <h1>241 Runners Awareness</h1>
        </div>

        <nav role="navigation" aria-label="Main navigation">
            <a href="index.html">Home</a>
            <a href="aboutus.html">About Us</a>
            <a href="cases.html">Cases</a>
            <a href="map.html" aria-current="page">🗺️ Map</a>
            <a href="dna-tracking.html">🧬 DNA</a>
            <a href="signup.html">Sign Up</a>
            <a href="login.html">Login</a>
            <a href="https://www.zeffy.com/en-US/donation-form/donate-to-241-runners-awareness-initiative" target="_blank" rel="noopener">Donate</a>
            <a href="https://linktr.ee/241Runners" target="_blank" rel="noopener">Follow Us</a>
        </nav>
        
        <button class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode" aria-pressed="false">
            ☀️
        </button>
        
        <button class="hamburger" aria-label="Toggle navigation menu" aria-expanded="false" aria-controls="main-navigation">
            <span></span>
            <span></span>
            <span></span>
        </button>
    </header>

    <main role="main">
        <div class="dashboard-container">
            <div class="map-container">
                <div class="welcome-section">
                    <h2>🗺️ Interactive Map Dashboard</h2>
                    <p>Real-time tracking of missing persons cases and community safety incidents in your area.</p>
                    <div class="realtime-indicator">
                        🔴 Live Updates
                    </div>
                </div>
                <!-- Map Controls -->
                <div class="map-controls">
                    <div class="control-group">
                        <button id="refreshBtn" class="secondary-btn">
                            🔄 Refresh Data
                        </button>
                        <button id="houstonBtn">
                            🏙️ Focus Houston
                        </button>
                        <button id="centerMapBtn" class="secondary-btn">
                            🎯 Center Map
                        </button>
                    </div>
                    
                    <div class="control-group">
                        <select id="statusFilter">
                            <option value="">All Statuses</option>
                            <option value="missing">Missing</option>
                            <option value="found">Found</option>
                            <option value="safe">Safe</option>
                            <option value="urgent">Urgent</option>
                        </select>
                        
                        <select id="timeFilter">
                            <option value="">All Time</option>
                            <option value="24h">Last 24 Hours</option>
                            <option value="7d">Last 7 Days</option>
                            <option value="30d">Last 30 Days</option>
                            <option value="90d">Last 90 Days</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <div class="search-box">
                            <input type="text" id="searchBox" placeholder="Search by name, location, or case ID...">
                            <span class="search-icon">🔍</span>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <button id="toggleClustersBtn" class="secondary-btn">
                            📊 Toggle Clusters
                        </button>
                        <button id="statsBtn">
                            📈 View Statistics
                        </button>
                        <button id="heatmapBtn" class="secondary-btn">
                            🔥 Heat Map
                        </button>
                        <button id="reportRunnerBtn" class="report-runner-btn">
                            🚨 Report Runner
                        </button>
                    </div>
                </div>

                <!-- Map -->
                <div id="map"></div>

                <!-- Loading States -->
                <div id="loading" class="loading" style="display: none;">
                    <div>🔄 Loading map data...</div>
                </div>
                
                <div id="error" class="error" style="display: none;">
                    Error loading map data
                </div>
                
                <div id="noData" class="no-data" style="display: none;">
                    No data available for the selected filters
                </div>

                <!-- Map Information -->
                <div class="map-info">
                    <h3>📊 Houston Area Statistics</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalCases">0</div>
                            <div class="stat-label">Total Cases</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="missingCases">0</div>
                            <div class="stat-label">Missing</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="foundCases">0</div>
                            <div class="stat-label">Found</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="safeCases">0</div>
                            <div class="stat-label">Safe</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="recentCases">0</div>
                            <div class="stat-label">Recent (30d)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="urgentCases">0</div>
                            <div class="stat-label">Urgent</div>
                        </div>
                    </div>
                    
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #f59e0b;"></div>
                            <span>Missing</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #dc2626;"></div>
                            <span>Found</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #10b981;"></div>
                            <span>Safe</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ef4444;"></div>
                            <span>Urgent</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer role="contentinfo">
        <p>&copy; 2025 241 Runners Awareness. All rights reserved.</p>
    </footer>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <script>
        // Enhanced Map Configuration
        const HOUSTON_LAT = 29.7604;
        const HOUSTON_LNG = -95.3698;
        const HOUSTON_RADIUS_MILES = 64.4;

        let map, markerClusterGroup, markers = [], currentData = [];
        let heatmapLayer = null;
        let realtimeInterval = null;

        // Initialize map with enhanced features
        function initMap() {
            console.log("Initializing map...");
            const mapContainer = document.getElementById("map");
            console.log("Map container:", mapContainer);
            
            if (!mapContainer) {
                console.error("Map container not found!");
                return;
            }
            
            try {
                map = L.map("map").setView([HOUSTON_LAT, HOUSTON_LNG], 10);
                console.log("Map created:", map);
                
                // Enhanced tile layer with better styling
                L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                    attribution: "© OpenStreetMap contributors",
                    maxZoom: 18
                }).addTo(map);

                // Initialize marker clustering
                markerClusterGroup = L.markerClusterGroup({
                    chunkedLoading: true,
                    maxClusterRadius: 50,
                    spiderfyOnMaxZoom: true,
                    showCoverageOnHover: true,
                    zoomToBoundsOnClick: true
                });
                map.addLayer(markerClusterGroup);

                // Add Houston area boundary
                const houstonCircle = L.circle([HOUSTON_LAT, HOUSTON_LNG], {
                    color: "#dc2626",
                    fillColor: "#dc2626",
                    fillOpacity: 0.05,
                    radius: HOUSTON_RADIUS_MILES * 1609.34,
                    weight: 2
                }).addTo(map);

                // Add area label
                L.marker([HOUSTON_LAT, HOUSTON_LNG]).addTo(map)
                    .bindPopup("<strong>Houston Metropolitan Area</strong><br>64.4-mile radius coverage")
                    .openPopup();
                    
                console.log("Map initialization completed successfully");
            } catch (error) {
                console.error("Error initializing map:", error);
            }
        }

        // Create custom marker with status-based styling
        function createCustomMarker(lat, lng, status, runner) {
            const colors = {
                missing: '#f59e0b',
                found: '#dc2626', 
                safe: '#10b981',
                urgent: '#ef4444',
                deceased: '#6b7280'
            };
            
            const color = colors[status] || '#6b7280';
            
            return L.circleMarker([lat, lng], {
                radius: 8,
                fillColor: color,
                color: '#fff',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            });
        }
        
        // Create popup content for markers
        function createPopupContent(runner) {
            return `
                <div class="runner-popup">
                    <h3>${runner.fullName || 'Unknown'}</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Status</div>
                            <div class="info-value">
                                <span class="status-badge status-${runner.currentStatus}">${runner.currentStatus}</span>
                            </div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Age</div>
                            <div class="info-value">${runner.age || 'Unknown'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Gender</div>
                            <div class="info-value">${runner.gender || 'Unknown'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Location</div>
                            <div class="info-value">${runner.city || 'Unknown'}, ${runner.state || 'Unknown'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Date Added</div>
                            <div class="info-value">${new Date(runner.dateAdded).toLocaleDateString()}</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Display runners on the map
        function displayRunners(runners) {
            // Clear existing markers
            markerClusterGroup.clearLayers();
            markers = [];
            
            if (!runners || runners.length === 0) {
                console.log("No runners data to display");
                return;
            }
            
            runners.forEach(runner => {
                if (runner.latitude && runner.longitude) {
                    const marker = createCustomMarker(
                        runner.latitude, 
                        runner.longitude, 
                        runner.currentStatus,
                        runner
                    );
                    
                    const popupContent = createPopupContent(runner);
                    marker.bindPopup(popupContent);
                    
                    markerClusterGroup.addLayer(marker);
                    markers.push(marker);
                }
            });
        }

        // Enhanced data loading with real-time updates
        async function loadRunnersData() {
            console.log("Loading runners data...");
            const loadingEl = document.getElementById("loading");
            const errorEl = document.getElementById("error");
            const noDataEl = document.getElementById("noData");
            
            if (loadingEl) loadingEl.style.display = "block";
            if (errorEl) errorEl.style.display = "none";
            if (noDataEl) noDataEl.style.display = "none";

            try {
                // Fetch real data from API
                let apiData = [];
                try {
                    if (window.apiUtils && window.apiUtils.fetchWithRetry) {
                        const response = await window.apiUtils.fetchWithRetry("/Runners");
                        const runners = await response.json();
                        if (runners && Array.isArray(runners)) {
                            apiData = runners;
                        }
                    }
                } catch (apiError) {
                    console.log("API data not available, using empty dataset:", apiError);
                }
                
                // Also try to get public cases data
                try {
                    if (window.apiUtils && window.apiUtils.fetchWithRetry) {
                        const response = await window.apiUtils.fetchWithRetry("/PublicCases");
                        const publicCases = await response.json();
                        if (publicCases && Array.isArray(publicCases)) {
                            // Convert public cases to runner format if needed
                            const convertedCases = publicCases.map(caseItem => ({
                                id: caseItem.id,
                                fullName: caseItem.fullName || caseItem.name || "Unknown",
                                currentStatus: caseItem.currentStatus || caseItem.status || "missing",
                                latitude: caseItem.latitude || caseItem.lat,
                                longitude: caseItem.longitude || caseItem.lng,
                                city: caseItem.city,
                                state: caseItem.state,
                                dateAdded: caseItem.dateAdded || caseItem.createdAt || new Date(),
                                address: caseItem.address,
                                age: caseItem.age,
                                gender: caseItem.gender,
                                dateOfBirth: caseItem.dateOfBirth
                            }));
                            apiData = [...apiData, ...convertedCases];
                        }
                    }
                } catch (publicCasesError) {
                    console.log("Public cases data not available:", publicCasesError);
                }
                
                currentData = apiData;
                
                // If no data from API, show sample data for demonstration
                if (apiData.length === 0) {
                    console.log("No API data available, showing sample data for demonstration");
                    const sampleData = [
                        {
                            id: 1,
                            fullName: "Sample Missing Person",
                            currentStatus: "missing",
                            latitude: 29.7604,
                            longitude: -95.3698,
                            city: "Houston",
                            state: "TX",
                            age: 25,
                            gender: "Male",
                            dateAdded: new Date().toISOString(),
                            address: "123 Main St, Houston, TX"
                        },
                        {
                            id: 2,
                            fullName: "Sample Found Person",
                            currentStatus: "found",
                            latitude: 29.7614,
                            longitude: -95.3598,
                            city: "Houston",
                            state: "TX",
                            age: 30,
                            gender: "Female",
                            dateAdded: new Date(Date.now() - 86400000).toISOString(),
                            address: "456 Oak Ave, Houston, TX"
                        }
                    ];
                    currentData = sampleData;
                }
                
                // Display the data on the map
                displayRunners(currentData);
                updateStatistics(currentData);
                
                // Hide loading state
                if (loadingEl) loadingEl.style.display = "none";
                
                // Show no data message if still no data
                if (currentData.length === 0) {
                    if (noDataEl) noDataEl.style.display = "block";
                }
                
            } catch (error) {
                console.error("Error loading runners data:", error);
                
                // Hide loading state
                if (loadingEl) loadingEl.style.display = "none";
                
                // Show error state
                if (errorEl) {
                    errorEl.style.display = "block";
                    errorEl.textContent = `Error loading map data: ${error.message}`;
                }
            }
        }

        // Update statistics display
        function updateStatistics(data = currentData) {
            const stats = {
                total: data.length,
                missing: data.filter(r => r.currentStatus === "missing").length,
                found: data.filter(r => r.currentStatus === "found").length,
                safe: data.filter(r => r.currentStatus === "safe").length,
                urgent: data.filter(r => r.currentStatus === "urgent").length,
                recent: data.filter(r => {
                    const daysSince = Math.floor((new Date() - new Date(r.dateAdded)) / (1000 * 60 * 60 * 24));
                    return daysSince <= 30;
                }).length
            };

            console.log("Updating statistics:", stats);

            // Safely update statistics with error handling
            const elements = {
                totalCases: document.getElementById("totalCases"),
                missingCases: document.getElementById("missingCases"),
                foundCases: document.getElementById("foundCases"),
                safeCases: document.getElementById("safeCases"),
                recentCases: document.getElementById("recentCases"),
                urgentCases: document.getElementById("urgentCases")
            };

            if (elements.totalCases) elements.totalCases.textContent = stats.total;
            if (elements.missingCases) elements.missingCases.textContent = stats.missing;
            if (elements.foundCases) elements.foundCases.textContent = stats.found;
            if (elements.safeCases) elements.safeCases.textContent = stats.safe;
            if (elements.recentCases) elements.recentCases.textContent = stats.recent;
            if (elements.urgentCases) elements.urgentCases.textContent = stats.urgent;
        }

        // Enhanced map controls
        function centerMap() {
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        function focusHouston() {
            map.setView([HOUSTON_LAT, HOUSTON_LNG], 10);
        }

        function toggleClusters() {
            if (map.hasLayer(markerClusterGroup)) {
                map.removeLayer(markerClusterGroup);
                markers.forEach(marker => map.addLayer(marker));
            } else {
                markers.forEach(marker => map.removeLayer(marker));
                map.addLayer(markerClusterGroup);
            }
        }

        // Heat map functionality
        function toggleHeatmap() {
            if (heatmapLayer) {
                map.removeLayer(heatmapLayer);
                heatmapLayer = null;
                document.getElementById("heatmapBtn").textContent = "🔥 Heat Map";
            } else {
                const heatmapData = currentData.map(runner => ({
                    lat: runner.latitude,
                    lng: runner.longitude,
                    value: runner.currentStatus === "missing" ? 3 : 
                           runner.currentStatus === "found" ? 2 : 1
                }));
                
                // Simple heat map implementation
                heatmapLayer = L.layerGroup();
                heatmapData.forEach(point => {
                    const circle = L.circle([point.lat, point.lng], {
                        radius: point.value * 1000,
                        fillColor: "#ff4444",
                        color: "#ff0000",
                        weight: 1,
                        opacity: 0.3,
                        fillOpacity: 0.1
                    });
                    heatmapLayer.addLayer(circle);
                });
                
                map.addLayer(heatmapLayer);
                document.getElementById("heatmapBtn").textContent = "🗺️ Normal Map";
            }
        }

        // Advanced filtering system
        function filterRunners() {
            const statusFilter = document.getElementById("statusFilter").value;
            const timeFilter = document.getElementById("timeFilter").value;
            const searchTerm = document.getElementById("searchBox").value.toLowerCase();
            
            let filteredData = currentData;
            
            // Status filter
            if (statusFilter) {
                filteredData = filteredData.filter(runner => 
                    runner.currentStatus === statusFilter
                );
            }
            
            // Time filter
            if (timeFilter) {
                const now = new Date();
                const filterDays = {
                    "24h": 1,
                    "7d": 7,
                    "30d": 30,
                    "90d": 90
                };
                
                const days = filterDays[timeFilter];
                if (days) {
                    const cutoffDate = new Date(now.getTime() - (days * 24 * 60 * 60 * 1000));
                    filteredData = filteredData.filter(runner => 
                        new Date(runner.dateAdded) >= cutoffDate
                    );
                }
            }
            
            // Search filter
            if (searchTerm) {
                filteredData = filteredData.filter(runner => 
                    runner.fullName.toLowerCase().includes(searchTerm) ||
                    (runner.city && runner.city.toLowerCase().includes(searchTerm)) ||
                    (runner.address && runner.address.toLowerCase().includes(searchTerm)) ||
                    runner.id.toString().includes(searchTerm)
                );
            }
            
            displayRunners(filteredData);
            updateStatistics(filteredData);
        }

        // Real-time updates simulation
        function startRealtimeUpdates() {
            realtimeInterval = setInterval(() => {
                loadRunnersData();
            }, 30000);
        }

        function stopRealtimeUpdates() {
            if (realtimeInterval) {
                clearInterval(realtimeInterval);
                realtimeInterval = null;
            }
        }

        // Event listeners
        document.addEventListener("DOMContentLoaded", function() {
            console.log("DOM Content Loaded - Starting map initialization...");
            
            // Wait for Leaflet to load
            if (typeof L === "undefined") {
                console.error("Leaflet library not loaded!");
                return;
            }
            
            initMap();
            loadRunnersData();
            startRealtimeUpdates();

            // Control event listeners
            const refreshBtn = document.getElementById("refreshBtn");
            const houstonBtn = document.getElementById("houstonBtn");
            const statusFilter = document.getElementById("statusFilter");
            const timeFilter = document.getElementById("timeFilter");
            const searchBox = document.getElementById("searchBox");
            const centerMapBtn = document.getElementById("centerMapBtn");
            const toggleClustersBtn = document.getElementById("toggleClustersBtn");
            const heatmapBtn = document.getElementById("heatmapBtn");
            const reportRunnerBtn = document.getElementById("reportRunnerBtn");
            if (refreshBtn) refreshBtn.addEventListener("click", loadRunnersData);
            if (houstonBtn) houstonBtn.addEventListener("click", focusHouston);
            if (statusFilter) statusFilter.addEventListener("change", filterRunners);
            if (timeFilter) timeFilter.addEventListener("change", filterRunners);
            if (searchBox) searchBox.addEventListener("input", filterRunners);
            if (centerMapBtn) centerMapBtn.addEventListener("click", centerMap);
            if (toggleClustersBtn) toggleClustersBtn.addEventListener("click", toggleClusters);
            if (heatmapBtn) heatmapBtn.addEventListener("click", toggleHeatmap);
            if (reportRunnerBtn) reportRunnerBtn.addEventListener("click", function() {
                window.location.href = "https://241runnersawareness.org/report-case.html";
            });
            // Theme toggle functionality
            const themeToggle = document.getElementById("theme-toggle");
            const body = document.body;
            
            const currentTheme = localStorage.getItem("theme") || "light";
            if (currentTheme === "dark") {
                body.classList.add("dark-mode");
                themeToggle.textContent = "🌙";
                themeToggle.setAttribute("aria-pressed", "true");
            }
            
            if (themeToggle) {
                themeToggle.addEventListener("click", function() {
                    body.classList.toggle("dark-mode");
                    
                    if (body.classList.contains("dark-mode")) {
                        localStorage.setItem("theme", "dark");
                        themeToggle.textContent = "🌙";
                        themeToggle.setAttribute("aria-pressed", "true");
                    } else {
                        localStorage.setItem("theme", "light");
                        themeToggle.textContent = "☀️";
                        themeToggle.setAttribute("aria-pressed", "false");
                    }
                });
            }

            // Sticky navbar scroll effect
            window.addEventListener("scroll", function() {
                const header = document.querySelector("header");
                if (window.scrollY > 50) {
                    header.classList.add("scrolled");
                } else {
                    header.classList.remove("scrolled");
                }
            });

            // Hamburger menu functionality
            const hamburger = document.querySelector(".hamburger");
            const nav = document.querySelector("nav");
            
            if (hamburger && nav) {
                hamburger.addEventListener("click", function() {
                    const isExpanded = hamburger.getAttribute("aria-expanded") === "true";
                    hamburger.setAttribute("aria-expanded", !isExpanded);
                    hamburger.classList.toggle("active");
                    nav.classList.toggle("active");
                });
                
                document.querySelectorAll("nav a").forEach(link => {
                    link.addEventListener("click", () => {
                        hamburger.classList.remove("active");
                        nav.classList.remove("active");
                    });
                });
                
                document.addEventListener("click", function(e) {
                    if (!hamburger.contains(e.target) && !nav.contains(e.target)) {
                        hamburger.classList.remove("active");
                        nav.classList.remove("active");
                    }
                });
            }
        });

        // Cleanup on page unload
        window.addEventListener("beforeunload", function() {
            stopRealtimeUpdates();
        });
    </script></body>
</html> 