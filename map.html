<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Map - 241 Runners Awareness</title>
    <!-- Google Maps API - Will be loaded dynamically with API key -->
    <script>
        // Load Google Maps API with configured key
        function loadGoogleMaps() {
            console.log('üîç Loading Google Maps...');
            console.log('üîç GOOGLE_MAPS_CONFIG:', typeof window.GOOGLE_MAPS_CONFIG);
            
            if (typeof window.GOOGLE_MAPS_CONFIG === 'undefined') {
                console.error('‚ùå Google Maps configuration not loaded');
                return;
            }
            
            const apiKey = window.GOOGLE_MAPS_CONFIG.API_KEY;
            console.log('üîç API Key:', apiKey ? `${apiKey.substring(0, 10)}...` : 'undefined');
            
            if (!apiKey || apiKey === 'YOUR_GOOGLE_MAPS_API_KEY') {
                console.error('‚ùå Google Maps API key not configured');
                showApiKeyError();
                return;
            }
            
            console.log('‚úÖ Google Maps API key is configured, loading script...');
            
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=geometry,places,visualization&callback=initGoogleMap`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        }
        
        function showApiKeyError() {
            const mapContainer = document.getElementById("map");
            if (mapContainer) {
                mapContainer.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f3f4f6; border-radius: 15px;">
                        <div style="text-align: center; padding: 40px; max-width: 400px;">
                            <h3 style="color: #dc2626; margin-bottom: 15px;">üîë Google Maps API Key Required</h3>
                            <p style="color: #666; margin-bottom: 15px;">Please configure your Google Maps API key in <code>google-maps-config.js</code></p>
                            <p style="color: #888; font-size: 0.9rem;">Replace <code>YOUR_GOOGLE_MAPS_API_KEY</code> with your actual API key from your mobile repository.</p>
                        </div>
                    </div>
                `;
            }
        }
        
        // Load Google Maps when DOM is ready with a small delay to ensure config loads
        document.addEventListener('DOMContentLoaded', function() {
            // Add a small delay to ensure google-maps-config.js loads first
            setTimeout(loadGoogleMaps, 100);
        });
    </script>
    <!-- MarkerClusterer library -->
    <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link rel="stylesheet" href="styles.css?v=20250905" />
    <script src="assets/js/config.js?v=20250905"></script>
    <script src="google-maps-config.js?v=20250905"></script>
    <script src="assets/js/api-utils.js"></script>
    <style>
        /* Enhanced Google Maps Styles */
        #map {
            height: 75vh;
            width: 100%;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            z-index: 1;
            position: relative;
        }
        
        /* Google Maps specific styles */
        .gm-style {
            border-radius: 15px;
        }
        
        .gm-style-iw {
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .gm-style-iw-d {
            overflow: hidden !important;
        }
        
        .map-container {
            position: relative;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .map-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
            align-items: center;
            justify-content: center;
            padding: 25px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .map-controls button {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .map-controls button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
            background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%);
        }
        
        .secondary-btn {
            background: linear-gradient(135deg, #374151 0%, #1f2937 100%) !important;
            box-shadow: 0 4px 15px rgba(55, 65, 81, 0.3) !important;
        }
        
        .secondary-btn:hover {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%) !important;
            box-shadow: 0 6px 20px rgba(55, 65, 81, 0.4) !important;
        }
        
        /* Report Runner Button */
        .report-runner-btn {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%) !important;
            color: white !important;
            font-weight: bold !important;
            padding: 12px 24px !important;
            border-radius: 25px !important;
            text-decoration: none !important;
            transition: all 0.3s ease !important;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3) !important;
            border: 2px solid transparent !important;
            cursor: pointer !important;
        }

        .report-runner-btn:hover {
            background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%) !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4) !important;
            color: white !important;
        }

        .report-runner-btn:focus {
            outline: 3px solid rgba(220, 38, 38, 0.3) !important;
            outline-offset: 2px !important;
        }
        
        .map-controls select, .map-controls input {
            padding: 12px 20px;
            border: 2px solid #e1e5e9;
            border-radius: 25px;
            background: white;
            color: #333;
            font-weight: 500;
            cursor: pointer;
            transition: border-color 0.3s;
            min-width: 150px;
        }
        
        .map-controls select:focus, .map-controls input:focus {
            outline: none;
            border-color: #dc2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }
        
        .search-box {
            position: relative;
            flex: 1;
        }
        
        .search-box input {
            width: 100%;
            padding-right: 40px;
        }
        
        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            pointer-events: none;
        }
        
        /* Enhanced Popup Styles */
        .runner-popup {
            text-align: left;
            padding: 15px;
            max-width: 300px;
        }
        
        .runner-popup h3 {
            margin: 0 0 15px 0;
            color: #dc2626;
            font-size: 1.3rem;
            border-bottom: 2px solid #f3f4f6;
            padding-bottom: 8px;
        }
        
        .runner-popup .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin: 10px 0;
        }
        
        .runner-popup .info-item {
            display: flex;
            flex-direction: column;
        }
        
        .runner-popup .info-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }
        
        .runner-popup .info-value {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }
        
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 5px 0;
        }
        
        .status-missing { background: #f59e0b; color: white; }
        .status-found { background: #dc2626; color: white; }
        .status-safe { background: #10b981; color: white; }
        .status-deceased { background: #6b7280; color: white; }
        .status-resolved_pending_verify { background: #8b5cf6; color: white; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Loading and Error States */
        .loading {
            text-align: center;
            padding: 60px;
            color: #666;
            font-size: 1.1rem;
        }
        
        .error {
            background: #dc2626;
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
        }
        
        .no-data {
            text-align: center;
            padding: 60px;
            color: #666;
            font-style: italic;
            font-size: 1.1rem;
        }

        /* Enhanced Info Panel */
        .map-info {
            margin-top: 30px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .map-info h3 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.4rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #e5e7eb;
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            color: #dc2626;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Real-time indicator */
        .realtime-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(16, 185, 129, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .realtime-indicator::before {
            content: '';
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        /* Dark mode adjustments */
        body.dark-mode #map {
            filter: brightness(0.8) contrast(1.2);
        }

        body.dark-mode .map-container {
            background: #1f2937;
        }

        body.dark-mode .map-info {
            background: rgba(31, 41, 55, 0.95);
            color: #fff;
        }

        body.dark-mode .map-info h3 {
            color: #fff;
        }

        body.dark-mode .legend-item,
        body.dark-mode .stat-card {
            background: #374151;
            color: #fff;
            border-color: #4b5563;
        }

        body.dark-mode .map-controls select,
        body.dark-mode .map-controls input {
            background: #374151;
            color: #fff;
            border-color: #4b5563;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .map-controls {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .control-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .map-controls button,
            .map-controls select,
            .map-controls input {
                width: 100%;
            }
            
            #map {
                height: 60vh;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <header role="banner">
        <div class="header-bar">
            <img src="assets/images/241-logo.jpg" alt="241 Runners Awareness Logo - Supporting missing and vulnerable individuals" class="logo" />
            <h1>241 Runners Awareness</h1>
        </div>

        <nav role="navigation" aria-label="Main navigation">
            <a href="index.html">Home</a>
            <a href="aboutus.html">About Us</a>
            <a href="cases.html">Cases</a>
            <a href="map.html" aria-current="page">üó∫Ô∏è Map</a>
            <a href="dna-tracking.html">üß¨ DNA</a>
            <a href="signup.html">Sign Up</a>
            <a href="login.html">Login</a>
            <a href="https://www.zeffy.com/en-US/donation-form/donate-to-241-runners-awareness-initiative" target="_blank" rel="noopener">Donate</a>
            <a href="https://linktr.ee/241Runners" target="_blank" rel="noopener">Follow Us</a>
        </nav>
        
        <button class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode" aria-pressed="false">
            ‚òÄÔ∏è
        </button>
        
        <button class="hamburger" aria-label="Toggle navigation menu" aria-expanded="false" aria-controls="main-navigation">
            <span></span>
            <span></span>
            <span></span>
        </button>
    </header>

    <main role="main">
        <div class="dashboard-container">
            <div class="map-container">
                <div class="welcome-section">
                    <h2>üó∫Ô∏è Interactive Map Dashboard</h2>
                    <p>Real-time tracking of missing persons cases and community safety incidents in your area.</p>
                    <div class="realtime-indicator">
                        üî¥ Live Updates
                    </div>
                </div>
                <!-- Map Controls -->
                <div class="map-controls">
                    <div class="control-group">
                        <button id="refreshBtn" class="secondary-btn">
                            üîÑ Refresh Data
                        </button>
                        <button id="houstonBtn">
                            üèôÔ∏è Focus Houston
                        </button>
                        <button id="centerMapBtn" class="secondary-btn">
                            üéØ Center Map
                        </button>
                    </div>
                    
                    <div class="control-group">
                        <select id="statusFilter">
                            <option value="">All Statuses</option>
                            <option value="missing">Missing</option>
                            <option value="found">Found</option>
                            <option value="safe">Safe</option>
                            <option value="urgent">Urgent</option>
                        </select>
                        
                        <select id="timeFilter">
                            <option value="">All Time</option>
                            <option value="24h">Last 24 Hours</option>
                            <option value="7d">Last 7 Days</option>
                            <option value="30d">Last 30 Days</option>
                            <option value="90d">Last 90 Days</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <div class="search-box">
                            <input type="text" id="searchBox" placeholder="Search by name, location, or case ID...">
                            <span class="search-icon">üîç</span>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <button id="toggleClustersBtn" class="secondary-btn">
                            üìä Toggle Clusters
                        </button>
                        <button id="statsBtn">
                            üìà View Statistics
                        </button>
                        <button id="heatmapBtn" class="secondary-btn">
                            üî• Heat Map
                        </button>
                        <button id="reportRunnerBtn" class="report-runner-btn">
                            üö® Report Runner
                        </button>
                    </div>
                </div>

                <!-- Map -->
                <div id="map"></div>

                <!-- Loading States -->
                <div id="loading" class="loading" style="display: none;">
                    <div>üîÑ Loading map data...</div>
                </div>
                
                <div id="error" class="error" style="display: none;">
                    Error loading map data
                </div>
                
                <div id="noData" class="no-data" style="display: none;">
                    No data available for the selected filters
                </div>

                <!-- Map Information -->
                <div class="map-info">
                    <h3>üìä Houston Area Statistics</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalCases">0</div>
                            <div class="stat-label">Total Cases</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="missingCases">0</div>
                            <div class="stat-label">Missing</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="foundCases">0</div>
                            <div class="stat-label">Found</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="safeCases">0</div>
                            <div class="stat-label">Safe</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="recentCases">0</div>
                            <div class="stat-label">Recent (30d)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="urgentCases">0</div>
                            <div class="stat-label">Urgent</div>
                        </div>
                    </div>
                    
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #f59e0b;"></div>
                            <span>Missing</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #dc2626;"></div>
                            <span>Found</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #10b981;"></div>
                            <span>Safe</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ef4444;"></div>
                            <span>Urgent</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer role="contentinfo">
        <p>&copy; 2025 241 Runners Awareness. All rights reserved.</p>
    </footer>

    <!-- Scripts -->
    <!-- Google Maps API will be loaded from head -->

    <script>
        // Enhanced Google Maps Configuration
        const HOUSTON_LAT = 29.7604;
        const HOUSTON_LNG = -95.3698;
        const HOUSTON_RADIUS_MILES = 64.4;

        let map, markerCluster, markers = [], currentData = [];
        let heatmapLayer = null;
        let realtimeInterval = null;
        let infoWindow = null;

        // Initialize Google Maps with enhanced features
        function initGoogleMap() {
            console.log("üöÄ Initializing Google Maps...");
            console.log("üöÄ Google Maps library loaded:", typeof google !== 'undefined');
            console.log("üöÄ Google Maps API available:", typeof google.maps !== 'undefined');
            
            const mapContainer = document.getElementById("map");
            console.log("üöÄ Map container:", mapContainer);
            
            if (!mapContainer) {
                console.error("Map container not found!");
                return;
            }
            
            try {
                // Initialize Google Map with configuration
                const config = window.GOOGLE_MAPS_CONFIG;
                map = new google.maps.Map(mapContainer, {
                    center: config.DEFAULT_CENTER,
                    zoom: config.DEFAULT_ZOOM,
                    mapTypeId: google.maps.MapTypeId.ROADMAP,
                    styles: config.MAP_STYLES,
                    mapTypeControl: true,
                    streetViewControl: false,
                    fullscreenControl: true,
                    zoomControl: true
                });
                
                console.log("Google Map created:", map);
                
                // Initialize marker clusterer
                markerCluster = new MarkerClusterer(map, [], config.CLUSTER_CONFIG);
                
                // Initialize info window
                infoWindow = new google.maps.InfoWindow();
                
                // Add Houston area boundary
                const houstonCircle = new google.maps.Circle({
                    strokeColor: "#dc2626",
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: "#dc2626",
                    fillOpacity: 0.05,
                    map: map,
                    center: { lat: HOUSTON_LAT, lng: HOUSTON_LNG },
                    radius: HOUSTON_RADIUS_MILES * 1609.34 // Convert miles to meters
                });
                
                // Add Houston area label
                const houstonMarker = new google.maps.Marker({
                    position: { lat: HOUSTON_LAT, lng: HOUSTON_LNG },
                    map: map,
                    title: "Houston Metropolitan Area",
                    icon: {
                        url: "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(`
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="#dc2626">
                                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                            </svg>
                        `),
                        scaledSize: new google.maps.Size(24, 24),
                        anchor: new google.maps.Point(12, 12)
                    }
                });
                
                houstonMarker.addListener("click", () => {
                    infoWindow.setContent(`
                        <div style="padding: 10px; max-width: 200px;">
                            <strong>Houston Metropolitan Area</strong><br>
                            64.4-mile radius coverage
                        </div>
                    `);
                    infoWindow.open(map, houstonMarker);
                });
                    
                console.log("Google Maps initialization completed successfully");
                
                // Load data after map is initialized
                loadRunnersData();
                
            } catch (error) {
                console.error("Error initializing Google Maps:", error);
            }
        }

        // Create custom Google Maps marker with status-based styling
        function createCustomMarker(lat, lng, status, runner) {
            const colors = {
                missing: '#f59e0b',
                found: '#dc2626', 
                safe: '#10b981',
                urgent: '#ef4444',
                deceased: '#6b7280'
            };
            
            const color = colors[status] || '#6b7280';
            
            // Create custom marker icon
            const icon = {
                url: "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(`
                    <svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="10" cy="10" r="8" fill="${color}" stroke="#fff" stroke-width="2"/>
                        <text x="10" y="14" text-anchor="middle" fill="white" font-size="8" font-weight="bold">
                            ${status.charAt(0).toUpperCase()}
                        </text>
                    </svg>
                `),
                scaledSize: new google.maps.Size(20, 20),
                anchor: new google.maps.Point(10, 10)
            };
            
            const marker = new google.maps.Marker({
                position: { lat: lat, lng: lng },
                map: map,
                icon: icon,
                title: runner.fullName || 'Unknown',
                animation: google.maps.Animation.DROP
            });
            
            // Add click listener for info window
            marker.addListener("click", () => {
                const content = createPopupContent(runner);
                infoWindow.setContent(content);
                infoWindow.open(map, marker);
            });
            
            return marker;
        }
        
        // Create popup content for Google Maps info windows
        function createPopupContent(runner) {
            return `
                <div style="padding: 15px; max-width: 300px; font-family: Arial, sans-serif;">
                    <h3 style="margin: 0 0 15px 0; color: #dc2626; font-size: 1.3rem; border-bottom: 2px solid #f3f4f6; padding-bottom: 8px;">
                        ${runner.fullName || 'Unknown'}
                    </h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 10px 0;">
                        <div style="display: flex; flex-direction: column;">
                            <div style="font-size: 11px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px;">
                                Status
                            </div>
                            <div style="font-size: 14px; color: #333; font-weight: 500;">
                                <span style="display: inline-block; padding: 6px 12px; border-radius: 15px; font-size: 12px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; margin: 5px 0; background: ${getStatusColor(runner.currentStatus)}; color: white;">
                                    ${runner.currentStatus}
                                </span>
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column;">
                            <div style="font-size: 11px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px;">
                                Age
                            </div>
                            <div style="font-size: 14px; color: #333; font-weight: 500;">
                                ${runner.age || 'Unknown'}
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column;">
                            <div style="font-size: 11px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px;">
                                Gender
                            </div>
                            <div style="font-size: 14px; color: #333; font-weight: 500;">
                                ${runner.gender || 'Unknown'}
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column;">
                            <div style="font-size: 11px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px;">
                                Location
                            </div>
                            <div style="font-size: 14px; color: #333; font-weight: 500;">
                                ${runner.city || 'Unknown'}, ${runner.state || 'Unknown'}
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; grid-column: 1 / -1;">
                            <div style="font-size: 11px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px;">
                                Date Added
                            </div>
                            <div style="font-size: 14px; color: #333; font-weight: 500;">
                                ${new Date(runner.dateAdded).toLocaleDateString()}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Helper function to get status color
        function getStatusColor(status) {
            const colors = {
                missing: '#f59e0b',
                found: '#dc2626', 
                safe: '#10b981',
                urgent: '#ef4444',
                deceased: '#6b7280'
            };
            return colors[status] || '#6b7280';
        }
        
        // Display runners on Google Maps
        function displayRunners(runners) {
            // Clear existing markers
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            markerCluster.clearMarkers();
            
            if (!runners || runners.length === 0) {
                console.log("No runners data to display");
                return;
            }
            
            runners.forEach(runner => {
                if (runner.latitude && runner.longitude) {
                    const marker = createCustomMarker(
                        runner.latitude, 
                        runner.longitude, 
                        runner.currentStatus,
                        runner
                    );
                    
                    markers.push(marker);
                }
            });
            
            // Add markers to cluster
            markerCluster.addMarkers(markers);
            
            console.log(`Displayed ${markers.length} markers on the map`);
        }

        // Enhanced data loading with real-time updates
        async function loadRunnersData() {
            console.log("Loading runners data...");
            const loadingEl = document.getElementById("loading");
            const errorEl = document.getElementById("error");
            const noDataEl = document.getElementById("noData");
            
            if (loadingEl) loadingEl.style.display = "block";
            if (errorEl) errorEl.style.display = "none";
            if (noDataEl) noDataEl.style.display = "none";

            try {
                // Fetch real data from API using correct endpoints
                let apiData = [];
                
                // Try to get public cases data (this endpoint doesn't require authentication)
                try {
                    if (window.apiUtils && window.apiUtils.fetchWithRetry) {
                        const response = await window.apiUtils.fetchWithRetry("/api/v1/cases/publiccases", {
                            ignoreHealthCheck: true // Allow even if API health check fails
                        });
                        const result = await response.json();
                        if (result && result.data && Array.isArray(result.data)) {
                            // Convert public cases to runner format
                            const convertedCases = result.data.map(caseItem => ({
                                id: caseItem.id,
                                fullName: caseItem.title || "Unknown",
                                currentStatus: caseItem.status || "missing",
                                latitude: 29.7604 + (Math.random() - 0.5) * 0.1, // Mock coordinates around Houston
                                longitude: -95.3698 + (Math.random() - 0.5) * 0.1,
                                city: "Houston",
                                state: "TX",
                                dateAdded: caseItem.createdAt || new Date(),
                                address: "Houston, TX",
                                age: "Unknown",
                                gender: "Unknown"
                            }));
                            apiData = [...apiData, ...convertedCases];
                            console.log(`Loaded ${convertedCases.length} public cases from API`);
                        }
                    }
                } catch (publicCasesError) {
                    console.log("Public cases data not available:", publicCasesError);
                }
                
                // Try to get map points data
                try {
                    if (window.apiUtils && window.apiUtils.fetchWithRetry) {
                        const response = await window.apiUtils.fetchWithRetry("/api/map/points?cluster=true", {
                            ignoreHealthCheck: true
                        });
                        const result = await response.json();
                        if (result && result.data && Array.isArray(result.data)) {
                            // Convert map points to runner format
                            const convertedPoints = result.data.map(point => ({
                                id: point.id,
                                fullName: "Map Point",
                                currentStatus: point.status || "missing",
                                latitude: point.lat,
                                longitude: point.lng,
                                city: "Houston",
                                state: "TX",
                                dateAdded: new Date(),
                                address: "Houston, TX",
                                age: "Unknown",
                                gender: "Unknown"
                            }));
                            apiData = [...apiData, ...convertedPoints];
                            console.log(`Loaded ${convertedPoints.length} map points from API`);
                        }
                    }
                } catch (mapPointsError) {
                    console.log("Map points data not available:", mapPointsError);
                }
                
                currentData = apiData;
                
                // If no data from API, show sample data for demonstration
                if (apiData.length === 0) {
                    console.log("No API data available, showing sample data for demonstration");
                    const sampleData = [
                        {
                            id: 1,
                            fullName: "Sample Missing Person",
                            currentStatus: "missing",
                            latitude: 29.7604,
                            longitude: -95.3698,
                            city: "Houston",
                            state: "TX",
                            age: 25,
                            gender: "Male",
                            dateAdded: new Date().toISOString(),
                            address: "123 Main St, Houston, TX"
                        },
                        {
                            id: 2,
                            fullName: "Sample Found Person",
                            currentStatus: "found",
                            latitude: 29.7614,
                            longitude: -95.3598,
                            city: "Houston",
                            state: "TX",
                            age: 30,
                            gender: "Female",
                            dateAdded: new Date(Date.now() - 86400000).toISOString(),
                            address: "456 Oak Ave, Houston, TX"
                        }
                    ];
                    currentData = sampleData;
                }
                
                // Display the data on the map
                displayRunners(currentData);
                updateStatistics(currentData);
                
                // Hide loading state
                if (loadingEl) loadingEl.style.display = "none";
                
                // Show no data message if still no data
                if (currentData.length === 0) {
                    if (noDataEl) noDataEl.style.display = "block";
                }
                
            } catch (error) {
                console.error("Error loading runners data:", error);
                
                // Hide loading state
                if (loadingEl) loadingEl.style.display = "none";
                
                // Show error state
                if (errorEl) {
                    errorEl.style.display = "block";
                    errorEl.textContent = `Error loading map data: ${error.message}`;
                }
            }
        }

        // Update statistics display
        function updateStatistics(data = currentData) {
            const stats = {
                total: data.length,
                missing: data.filter(r => r.currentStatus === "missing").length,
                found: data.filter(r => r.currentStatus === "found").length,
                safe: data.filter(r => r.currentStatus === "safe").length,
                urgent: data.filter(r => r.currentStatus === "urgent").length,
                recent: data.filter(r => {
                    const daysSince = Math.floor((new Date() - new Date(r.dateAdded)) / (1000 * 60 * 60 * 24));
                    return daysSince <= 30;
                }).length
            };

            console.log("Updating statistics:", stats);

            // Safely update statistics with error handling
            const elements = {
                totalCases: document.getElementById("totalCases"),
                missingCases: document.getElementById("missingCases"),
                foundCases: document.getElementById("foundCases"),
                safeCases: document.getElementById("safeCases"),
                recentCases: document.getElementById("recentCases"),
                urgentCases: document.getElementById("urgentCases")
            };

            if (elements.totalCases) elements.totalCases.textContent = stats.total;
            if (elements.missingCases) elements.missingCases.textContent = stats.missing;
            if (elements.foundCases) elements.foundCases.textContent = stats.found;
            if (elements.safeCases) elements.safeCases.textContent = stats.safe;
            if (elements.recentCases) elements.recentCases.textContent = stats.recent;
            if (elements.urgentCases) elements.urgentCases.textContent = stats.urgent;
        }

        // Enhanced Google Maps controls
        function centerMap() {
            if (markers.length > 0) {
                const bounds = new google.maps.LatLngBounds();
                markers.forEach(marker => {
                    bounds.extend(marker.getPosition());
                });
                map.fitBounds(bounds);
            }
        }

        function focusHouston() {
            map.setCenter({ lat: HOUSTON_LAT, lng: HOUSTON_LNG });
            map.setZoom(10);
        }

        function toggleClusters() {
            if (markerCluster.getMarkers().length > 0) {
                // Show individual markers
                markerCluster.clearMarkers();
                markers.forEach(marker => marker.setMap(map));
                document.getElementById("toggleClustersBtn").textContent = "üìä Enable Clusters";
            } else {
                // Show clustered markers
                markers.forEach(marker => marker.setMap(null));
                markerCluster.addMarkers(markers);
                document.getElementById("toggleClustersBtn").textContent = "üìä Disable Clusters";
            }
        }

        // Heat map functionality using Google Maps
        function toggleHeatmap() {
            if (heatmapLayer) {
                heatmapLayer.setMap(null);
                heatmapLayer = null;
                document.getElementById("heatmapBtn").textContent = "üî• Heat Map";
                // Show markers again
                markers.forEach(marker => marker.setMap(map));
            } else {
                // Hide markers when showing heatmap
                markers.forEach(marker => marker.setMap(null));
                
                const heatmapData = currentData.map(runner => ({
                    location: new google.maps.LatLng(runner.latitude, runner.longitude),
                    weight: runner.currentStatus === "missing" ? 3 : 
                           runner.currentStatus === "found" ? 2 : 1
                }));
                
                const config = window.GOOGLE_MAPS_CONFIG;
                heatmapLayer = new google.maps.visualization.HeatmapLayer({
                    data: heatmapData,
                    map: map,
                    radius: config.HEATMAP_CONFIG.radius,
                    opacity: config.HEATMAP_CONFIG.opacity
                });
                
                document.getElementById("heatmapBtn").textContent = "üó∫Ô∏è Normal Map";
            }
        }

        // Advanced filtering system
        function filterRunners() {
            const statusFilter = document.getElementById("statusFilter").value;
            const timeFilter = document.getElementById("timeFilter").value;
            const searchTerm = document.getElementById("searchBox").value.toLowerCase();
            
            let filteredData = currentData;
            
            // Status filter
            if (statusFilter) {
                filteredData = filteredData.filter(runner => 
                    runner.currentStatus === statusFilter
                );
            }
            
            // Time filter
            if (timeFilter) {
                const now = new Date();
                const filterDays = {
                    "24h": 1,
                    "7d": 7,
                    "30d": 30,
                    "90d": 90
                };
                
                const days = filterDays[timeFilter];
                if (days) {
                    const cutoffDate = new Date(now.getTime() - (days * 24 * 60 * 60 * 1000));
                    filteredData = filteredData.filter(runner => 
                        new Date(runner.dateAdded) >= cutoffDate
                    );
                }
            }
            
            // Search filter
            if (searchTerm) {
                filteredData = filteredData.filter(runner => 
                    runner.fullName.toLowerCase().includes(searchTerm) ||
                    (runner.city && runner.city.toLowerCase().includes(searchTerm)) ||
                    (runner.address && runner.address.toLowerCase().includes(searchTerm)) ||
                    runner.id.toString().includes(searchTerm)
                );
            }
            
            displayRunners(filteredData);
            updateStatistics(filteredData);
        }

        // Real-time updates simulation
        function startRealtimeUpdates() {
            realtimeInterval = setInterval(() => {
                loadRunnersData();
            }, 30000);
        }

        function stopRealtimeUpdates() {
            if (realtimeInterval) {
                clearInterval(realtimeInterval);
                realtimeInterval = null;
            }
        }

        // Event listeners
        document.addEventListener("DOMContentLoaded", function() {
            console.log("DOM Content Loaded - Starting Google Maps initialization...");
            
            // Wait for Google Maps to load
            if (typeof google === "undefined" || typeof google.maps === "undefined") {
                console.error("Google Maps library not loaded!");
                // Show error message
                const mapContainer = document.getElementById("map");
                if (mapContainer) {
                    mapContainer.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f3f4f6; border-radius: 15px;">
                            <div style="text-align: center; padding: 40px;">
                                <h3 style="color: #dc2626; margin-bottom: 10px;">Google Maps Not Available</h3>
                                <p style="color: #666;">Please check your Google Maps API key configuration.</p>
                            </div>
                        </div>
                    `;
                }
                return;
            }
            
            // Google Maps will initialize via callback
            console.log("Google Maps API loaded successfully");

            // Control event listeners
            const refreshBtn = document.getElementById("refreshBtn");
            const houstonBtn = document.getElementById("houstonBtn");
            const statusFilter = document.getElementById("statusFilter");
            const timeFilter = document.getElementById("timeFilter");
            const searchBox = document.getElementById("searchBox");
            const centerMapBtn = document.getElementById("centerMapBtn");
            const toggleClustersBtn = document.getElementById("toggleClustersBtn");
            const heatmapBtn = document.getElementById("heatmapBtn");
            const reportRunnerBtn = document.getElementById("reportRunnerBtn");
            if (refreshBtn) refreshBtn.addEventListener("click", loadRunnersData);
            if (houstonBtn) houstonBtn.addEventListener("click", focusHouston);
            if (statusFilter) statusFilter.addEventListener("change", filterRunners);
            if (timeFilter) timeFilter.addEventListener("change", filterRunners);
            if (searchBox) searchBox.addEventListener("input", filterRunners);
            if (centerMapBtn) centerMapBtn.addEventListener("click", centerMap);
            if (toggleClustersBtn) toggleClustersBtn.addEventListener("click", toggleClusters);
            if (heatmapBtn) heatmapBtn.addEventListener("click", toggleHeatmap);
            if (reportRunnerBtn) reportRunnerBtn.addEventListener("click", function() {
                window.location.href = "https://241runnersawareness.org/report-case.html";
            });
            // Theme toggle functionality
            const themeToggle = document.getElementById("theme-toggle");
            const body = document.body;
            
            const currentTheme = localStorage.getItem("theme") || "light";
            if (currentTheme === "dark") {
                body.classList.add("dark-mode");
                themeToggle.textContent = "üåô";
                themeToggle.setAttribute("aria-pressed", "true");
            }
            
            if (themeToggle) {
                themeToggle.addEventListener("click", function() {
                    body.classList.toggle("dark-mode");
                    
                    if (body.classList.contains("dark-mode")) {
                        localStorage.setItem("theme", "dark");
                        themeToggle.textContent = "üåô";
                        themeToggle.setAttribute("aria-pressed", "true");
                    } else {
                        localStorage.setItem("theme", "light");
                        themeToggle.textContent = "‚òÄÔ∏è";
                        themeToggle.setAttribute("aria-pressed", "false");
                    }
                });
            }

            // Sticky navbar scroll effect
            window.addEventListener("scroll", function() {
                const header = document.querySelector("header");
                if (window.scrollY > 50) {
                    header.classList.add("scrolled");
                } else {
                    header.classList.remove("scrolled");
                }
            });

            // Hamburger menu functionality
            const hamburger = document.querySelector(".hamburger");
            const nav = document.querySelector("nav");
            
            if (hamburger && nav) {
                hamburger.addEventListener("click", function() {
                    const isExpanded = hamburger.getAttribute("aria-expanded") === "true";
                    hamburger.setAttribute("aria-expanded", !isExpanded);
                    hamburger.classList.toggle("active");
                    nav.classList.toggle("active");
                });
                
                document.querySelectorAll("nav a").forEach(link => {
                    link.addEventListener("click", () => {
                        hamburger.classList.remove("active");
                        nav.classList.remove("active");
                    });
                });
                
                document.addEventListener("click", function(e) {
                    if (!hamburger.contains(e.target) && !nav.contains(e.target)) {
                        hamburger.classList.remove("active");
                        nav.classList.remove("active");
                    }
                });
            }
        });

        // Cleanup on page unload
        window.addEventListener("beforeunload", function() {
            stopRealtimeUpdates();
        });
    </script></body>
</html> 