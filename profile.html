<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Profile - 241Runners Awareness</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="auth-utils.js"></script>
  <link rel="stylesheet" href="styles.css?v=20250128b" />
</head>
<body>
  <!-- Header -->
  <header role="banner">
    <nav class="navbar">
      <div class="nav-container">
        <div class="nav-brand">
          <a href="index.html">
            <img src="241-logo.jpg" alt="241 Runners Awareness Logo - Supporting missing and vulnerable individuals" class="logo" />
          </a>
        </div>
        <div class="nav-menu" id="navMenu">
          <a href="index.html" class="nav-link">Home</a>
          <a href="map.html">ÔøΩÔøΩÔ∏è Map</a>
          <a href="dna-tracking.html">üß¨ DNA Tracking</a>
          <a href="aboutus.html">‚ÑπÔ∏è About</a>
          <a href="profile.html" class="nav-link" id="profileLink" style="display: none;">Profile</a>
          <a href="admin-dashboard.html" class="nav-link" id="dashboardLink" style="display: none;">Dashboard</a>
          <a href="user-management.html" class="nav-link" id="userManagementLink" style="display: none;">User Management</a>
          <a href="login.html" class="nav-link" id="loginLink">Login</a>
          <a href="signup.html" class="nav-link" id="signupLink">Sign Up</a>
          <button class="nav-link logout-btn" id="logoutBtn" style="display: none;" onclick="handleLogout()">Logout</button>
        </div>
        <div class="nav-toggle" id="navToggle">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
    </nav>
  </header>

  <main role="main">
    <div class="container">
      <div class="profile-container">
        <div class="profile-card">
          <div class="profile-header">
            <h1>üë§ User Profile</h1>
            <p>Manage your account information and settings</p>
          </div>

          <!-- Profile Information -->
          <div class="profile-section">
            <h2>Account Information</h2>
            <div class="profile-info">
              <div class="info-item">
                <label>Email:</label>
                <span id="userEmail">Loading...</span>
                <span class="verified-badge" id="emailVerified" style="display: none;">‚úì</span>
              </div>
              <div class="info-item">
                <label>Full Name:</label>
                <span id="userFullName">Loading...</span>
              </div>
              <div class="info-item">
                <label>Role:</label>
                <span id="userRole">Loading...</span>
              </div>
              <div class="info-item">
                <label>Phone Number:</label>
                <span id="userPhone">Loading...</span>
                <span class="verified-badge" id="phoneVerified" style="display: none;">‚úì</span>
              </div>
              <div class="info-item">
                <label>Member Since:</label>
                <span id="userCreatedAt">Loading...</span>
              </div>
            </div>
          </div>

          <!-- Update Phone Number -->
          <div class="profile-section">
            <h2>Update Phone Number</h2>
            <form id="updatePhoneForm" class="profile-form">
              <div class="form-group">
                <label for="newPhone">New Phone Number</label>
                <input type="tel" id="newPhone" name="newPhone" placeholder="(555) 123-4567" required>
              </div>
              <button type="submit" class="btn btn-primary">Update Phone Number</button>
            </form>
          </div>

          <!-- Change Password -->
          <div class="profile-section">
            <h2>Change Password</h2>
            <form id="changePasswordForm" class="profile-form">
              <div class="form-group">
                <label for="currentPassword">Current Password</label>
                <input type="password" id="currentPassword" name="currentPassword" required>
              </div>
              <div class="form-group">
                <label for="newPassword">New Password</label>
                <input type="password" id="newPassword" name="newPassword" minlength="8" required>
                <small>Password must be at least 8 characters long</small>
              </div>
              <div class="form-group">
                <label for="confirmNewPassword">Confirm New Password</label>
                <input type="password" id="confirmNewPassword" name="confirmNewPassword" minlength="8" required>
              </div>
              <button type="submit" class="btn btn-primary">Change Password</button>
            </form>
          </div>

          <!-- Account Actions -->
          <div class="profile-section">
            <h2>Account Actions</h2>
            <div class="account-actions">
              <button class="btn btn-secondary" onclick="requestPasswordReset()">Request Password Reset Email</button>
              <button class="btn btn-danger" onclick="deleteAccount()">Delete Account</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer role="contentinfo">
    <p>&copy; 2025 241 Runners Awareness. All rights reserved.</p>
  </footer>

  <script>
    let currentUser = null;

    // Check authentication and load user data
    function checkAuthAndLoadProfile() {
      const user = localStorage.getItem('user');
      if (!user) {
        window.location.href = 'login.html';
        return;
      }

      try {
        currentUser = JSON.parse(user);
        loadUserProfile();
        updateNavigation();
      } catch (error) {
        console.error('Error parsing user data:', error);
        localStorage.removeItem('user');
        window.location.href = 'login.html';
      }
    }

    // Load user profile data
    function loadUserProfile() {
      if (!currentUser) return;

      document.getElementById('userEmail').textContent = currentUser.email || 'N/A';
      document.getElementById('userFullName').textContent = currentUser.fullName || 'N/A';
      document.getElementById('userRole').textContent = currentUser.role || 'N/A';
      document.getElementById('userPhone').textContent = currentUser.phoneNumber || 'Not set';
      document.getElementById('userCreatedAt').textContent = currentUser.createdAt ? 
        new Date(currentUser.createdAt).toLocaleDateString() : 'N/A';

      // Show verification badges
      if (currentUser.emailVerified) {
        document.getElementById('emailVerified').style.display = 'inline';
      }
      if (currentUser.phoneVerified) {
        document.getElementById('phoneVerified').style.display = 'inline';
      }
    }

    // Update navigation based on user role
    function updateNavigation() {
      const profileLink = document.getElementById('profileLink');
      const dashboardLink = document.getElementById('dashboardLink');
      const userManagementLink = document.getElementById('userManagementLink');
      const loginLink = document.getElementById('loginLink');
      const signupLink = document.getElementById('signupLink');
      const logoutBtn = document.getElementById('logoutBtn');

      if (currentUser) {
        profileLink.style.display = 'inline-block';
        logoutBtn.style.display = 'inline-block';
        loginLink.style.display = 'none';
        signupLink.style.display = 'none';

        if (currentUser.role === 'admin') {
          dashboardLink.style.display = 'inline-block';
          userManagementLink.style.display = 'inline-block';
        }
      } else {
        profileLink.style.display = 'none';
        dashboardLink.style.display = 'none';
        userManagementLink.style.display = 'none';
        logoutBtn.style.display = 'none';
        loginLink.style.display = 'inline-block';
        signupLink.style.display = 'inline-block';
      }
    }

    // Handle phone number update
    document.getElementById('updatePhoneForm').addEventListener('submit', async function(event) {
      event.preventDefault();
      
      const newPhone = document.getElementById('newPhone').value;
      
      try {
        // For now, update the local user data (in real implementation, this would call the API)
        currentUser.phoneNumber = newPhone;
        currentUser.phoneVerified = false; // Reset verification
        localStorage.setItem('user', JSON.stringify(currentUser));
        
        loadUserProfile();
        showNotification('Phone number updated successfully! Please verify your new phone number.', 'success');
        document.getElementById('updatePhoneForm').reset();
      } catch (error) {
        console.error('Error updating phone number:', error);
        showNotification('Error updating phone number. Please try again.', 'error');
      }
    });

    // Handle password change
    document.getElementById('changePasswordForm').addEventListener('submit', async function(event) {
      event.preventDefault();
      
      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmNewPassword = document.getElementById('confirmNewPassword').value;

      if (newPassword !== confirmNewPassword) {
        showNotification('New passwords do not match!', 'error');
        return;
      }

      if (newPassword.length < 8) {
        showNotification('New password must be at least 8 characters long!', 'error');
        return;
      }

      try {
        // For now, show success message (in real implementation, this would call the API)
        showNotification('Password changed successfully!', 'success');
        document.getElementById('changePasswordForm').reset();
      } catch (error) {
        console.error('Error changing password:', error);
        showNotification('Error changing password. Please try again.', 'error');
      }
    });

    // Request password reset
    function requestPasswordReset() {
      showNotification('Password reset email sent! Check your inbox.', 'success');
    }

    // Delete account
    function deleteAccount() {
      if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
        localStorage.removeItem('user');
        showNotification('Account deleted. Redirecting to home page...', 'success');
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 2000);
      }
    }

    // Show notification function
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification notification-${type}`;
      notification.textContent = message;
      
      // Style the notification
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 1000;
        max-width: 400px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        animation: slideIn 0.3s ease-out;
      `;
      
      // Set background color based on type
      switch(type) {
        case 'success':
          notification.style.backgroundColor = '#10b981';
          break;
        case 'error':
          notification.style.backgroundColor = '#ef4444';
          break;
        case 'warning':
          notification.style.backgroundColor = '#f59e0b';
          break;
        default:
          notification.style.backgroundColor = '#3b82f6';
      }
      
      document.body.appendChild(notification);
      
      // Remove notification after 5 seconds
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 5000);
    }

    // Add CSS animations
    const style = document.createElement('style');
    style.textContent = `
      .profile-container {
        max-width: 800px;
        margin: 2rem auto;
        padding: 0 1rem;
      }

      .profile-card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      body.dark-mode .profile-card {
        background: #374151;
        color: #f9fafb;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      .profile-header {
        background: linear-gradient(135deg, #ff0000, #ff6b6b);
        color: white;
        padding: 2rem;
        text-align: center;
      }

      .profile-header h1 {
        margin: 0 0 0.5rem 0;
        font-size: 2rem;
      }

      .profile-header p {
        margin: 0;
        opacity: 0.9;
      }

      .profile-section {
        padding: 2rem;
        border-bottom: 1px solid #e5e7eb;
      }

      body.dark-mode .profile-section {
        border-bottom-color: #6b7280;
      }

      .profile-section:last-child {
        border-bottom: none;
      }

      .profile-section h2 {
        color: #ff0000;
        margin: 0 0 1rem 0;
        font-size: 1.5rem;
      }

      body.dark-mode .profile-section h2 {
        color: #ff6b6b;
      }

      .profile-info {
        display: grid;
        gap: 1rem;
      }

      .info-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: #f9fafb;
        border-radius: 8px;
      }

      body.dark-mode .info-item {
        background: #4b5563;
      }

      .info-item label {
        font-weight: 600;
        min-width: 120px;
        color: #374151;
      }

      body.dark-mode .info-item label {
        color: #d1d5db;
      }

      .info-item span {
        color: #6b7280;
      }

      body.dark-mode .info-item span {
        color: #9ca3af;
      }

      .verified-badge {
        color: #10b981 !important;
        font-weight: bold;
      }

      .profile-form {
        display: grid;
        gap: 1rem;
        max-width: 400px;
      }

      .account-actions {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      
      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }

      @media (max-width: 768px) {
        .profile-container {
          margin: 1rem auto;
        }

        .profile-header {
          padding: 1.5rem;
        }

        .profile-section {
          padding: 1.5rem;
        }

        .info-item {
          flex-direction: column;
          align-items: flex-start;
          gap: 0.5rem;
        }

        .info-item label {
          min-width: auto;
        }

        .account-actions {
          flex-direction: column;
        }
      }
    `;
    document.head.appendChild(style);

    // Hamburger menu functionality
    document.getElementById('navToggle').addEventListener('click', function() {
      document.getElementById('navMenu').classList.toggle('active');
      this.classList.toggle('active');
    });

    // Initialize page
    checkAuthAndLoadProfile();
  </script>
</body>
</html>
