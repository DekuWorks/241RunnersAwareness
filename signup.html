<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign Up - 241Runners Awareness</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="auth-utils.js"></script>
  <link rel="stylesheet" href="styles.css?v=20250127a&t=20250127" />
</head>
<body>
  <header role="banner">
    <div class="header-bar">
      <img src="/241-logo.jpg" alt="241 Runners Awareness Logo - Supporting missing and vulnerable individuals" class="logo" />
      <h1>241 Runners Awareness</h1>
    </div>

    <nav role="navigation" aria-label="Main navigation">
      <a href="index.html">Home</a>
      <a href="aboutus.html">About Us</a>
      <a href="cases.html">Cases</a>
      <a href="map.html">üó∫Ô∏è Map</a>
      <a href="dna-tracking.html">üß¨ DNA Tracking</a>
      <a href="aboutus.html">‚ÑπÔ∏è About</a>
      <a href="signup.html" id="signupLink" aria-current="page">Sign Up</a>
      <a href="login.html" id="loginLink">Login</a>
      <button id="logoutBtn" style="display: none;" class="logout-btn">Logout</button>
      <a href="https://usatriathlonfoundation.salsalabs.org/241RunnersAwareness/index.html" target="_blank" rel="noopener" aria-label="Donate to 241 Runners Awareness (opens in new window)">Donate</a>
      <a href="https://linktr.ee/241Runners" target="_blank" rel="noopener" aria-label="Follow 241 Runners on social media (opens in new window)">Follow Us</a>
    </nav>
    
    <button class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode" aria-pressed="false">
      ‚òÄÔ∏è
    </button>
    
    <button class="hamburger" aria-label="Toggle navigation menu" aria-expanded="false" aria-controls="main-navigation">
      <span></span>
      <span></span>
      <span></span>
    </button>
    <div class="back-button">
      <a href="index.html" class="back-btn">&larr; Back to Home</a>
    </div>
  </header>

  <main role="main">
    <div class="signup-container">
      <h2>Create Your Account</h2>
      
      <div class="google-btn-container">
        <div id="g_id_onload"
             data-client_id=""
             data-context="signup"
             data-ux_mode="popup"
             data-callback="handleCredentialResponse"
             data-auto_prompt="false">
        </div>
        <div class="g_id_signin"
             data-type="standard"
             data-shape="rectangular"
             data-theme="outline"
             data-text="signup_with"
             data-size="large"
             data-logo_alignment="left">
        </div>
      </div>

      <div class="divider">or</div>

      <form id="signupForm" class="signup-form">
        <div class="form-group">
          <label for="role">Account Type *</label>
          <select id="role" name="role" required>
            <option value="">Select your role</option>
            <option value="user">General User</option>
            <option value="parent">Parent</option>
            <option value="caregiver">Caregiver</option>
            <option value="therapist">Therapist</option>
            <option value="adoptive_parent">Adoptive Parent</option>
          </select>
        </div>

        <div class="form-group">
          <label for="fullName">Full Name *</label>
          <input type="text" id="fullName" name="fullName" required placeholder="Enter your full name">
        </div>

        <div class="form-group">
          <label for="email">Email Address *</label>
          <input type="email" id="email" name="email" required placeholder="Enter your email">
        </div>

        <div class="form-group">
          <label for="phone">Phone Number *</label>
          <input type="tel" id="phone" name="phone" required placeholder="Enter your phone number">
        </div>

        <div class="form-group">
          <label for="password">Password *</label>
          <input type="password" id="password" name="password" required placeholder="Create a password">
        </div>

        <div class="form-group">
          <label for="confirmPassword">Confirm Password *</label>
          <input type="password" id="confirmPassword" name="confirmPassword" required placeholder="Confirm your password">
        </div>

        <!-- Conditional fields based on role -->
        <div id="individualFields" style="display: none;">
          <h3>Individual Information</h3>
          
          <div class="form-group">
            <label for="individualName">Individual's Name *</label>
            <input type="text" id="individualName" name="individualName" placeholder="Enter individual's full name">
          </div>

          <div class="form-group">
            <label for="individualAge">Age *</label>
            <input type="number" id="individualAge" name="individualAge" min="0" max="120" placeholder="Enter age">
          </div>

          <div class="form-group">
            <label for="individualHeight">Height (inches)</label>
            <input type="number" id="individualHeight" name="individualHeight" min="0" max="120" placeholder="Height in inches">
          </div>

          <div class="form-group">
            <label for="individualWeight">Weight (lbs)</label>
            <input type="number" id="individualWeight" name="individualWeight" min="0" max="1000" placeholder="Weight in pounds">
          </div>

          <div class="form-group">
            <label for="individualDescription">Description</label>
            <textarea id="individualDescription" name="individualDescription" rows="3" placeholder="Physical description, identifying features, etc."></textarea>
          </div>

          <div class="form-group">
            <label for="emergencyContact">Emergency Contact Name</label>
            <input type="text" id="emergencyContact" name="emergencyContact" placeholder="Emergency contact name">
          </div>

          <div class="form-group">
            <label for="emergencyPhone">Emergency Contact Phone</label>
            <input type="tel" id="emergencyPhone" name="emergencyPhone" placeholder="Emergency contact phone">
          </div>
        </div>

        <!-- Role-specific fields -->
        <div id="roleSpecificFields" style="display: none;">
          <h3>Role-Specific Information</h3>
          
          <!-- For parents, caregivers, adoptive parents -->
          <div id="relationshipFields" style="display: none;">
            <div class="form-group">
              <label for="relationshipToRunner">Relationship to Runner</label>
              <input type="text" id="relationshipToRunner" name="relationshipToRunner" placeholder="e.g., Mother, Father, Guardian">
            </div>
          </div>

          <!-- For therapists -->
          <div id="therapistFields" style="display: none;">
            <div class="form-group">
              <label for="licenseNumber">License Number</label>
              <input type="text" id="licenseNumber" name="licenseNumber" placeholder="Enter your license number">
            </div>

            <div class="form-group">
              <label for="organization">Organization</label>
              <input type="text" id="organization" name="organization" placeholder="Enter your organization">
            </div>

            <div class="form-group">
              <label for="credentials">Credentials</label>
              <input type="text" id="credentials" name="credentials" placeholder="e.g., BCBA, LCSW, PhD">
            </div>

            <div class="form-group">
              <label for="specialization">Specialization</label>
              <input type="text" id="specialization" name="specialization" placeholder="e.g., ABA Therapy, Behavioral Analysis">
            </div>

            <div class="form-group">
              <label for="yearsOfExperience">Years of Experience</label>
              <input type="text" id="yearsOfExperience" name="yearsOfExperience" placeholder="e.g., 5+, 10+">
            </div>
          </div>

          <!-- For caregivers -->
          <div id="caregiverFields" style="display: none;">
            <div class="form-group">
              <label for="organization">Organization</label>
              <input type="text" id="organization" name="organization" placeholder="Enter your organization">
            </div>

            <div class="form-group">
              <label for="yearsOfExperience">Years of Experience</label>
              <input type="text" id="yearsOfExperience" name="yearsOfExperience" placeholder="e.g., 3+, 7+">
            </div>
          </div>
        </div>

        <!-- Common additional fields -->
        <div id="additionalFields" style="display: none;">
          <h3>Additional Information</h3>
          
          <div class="form-group">
            <label for="address">Address</label>
            <input type="text" id="address" name="address" placeholder="Enter your address">
          </div>

          <div class="form-group">
            <label for="city">City</label>
            <input type="text" id="city" name="city" placeholder="Enter your city">
          </div>

          <div class="form-group">
            <label for="state">State</label>
            <input type="text" id="state" name="state" placeholder="Enter your state">
          </div>

          <div class="form-group">
            <label for="zipCode">Zip Code</label>
            <input type="text" id="zipCode" name="zipCode" placeholder="Enter your zip code">
          </div>

          <div class="form-group">
            <label for="emergencyContactName">Emergency Contact Name</label>
            <input type="text" id="emergencyContactName" name="emergencyContactName" placeholder="Emergency contact name">
          </div>

          <div class="form-group">
            <label for="emergencyContactPhone">Emergency Contact Phone</label>
            <input type="tel" id="emergencyContactPhone" name="emergencyContactPhone" placeholder="Emergency contact phone">
          </div>

          <div class="form-group">
            <label for="emergencyContactRelationship">Emergency Contact Relationship</label>
            <input type="text" id="emergencyContactRelationship" name="emergencyContactRelationship" placeholder="e.g., Spouse, Parent, Friend">
          </div>
        </div>

        <div class="form-group">
          <input type="submit" value="Create Account" class="submit-btn">
        </div>
      </form>

      <div id="message" class="message" style="display: none;"></div>

      <div class="login-link">
        Already have an account? <a href="login.html">Login here</a>
      </div>
    </div>
  </main>

  <footer role="contentinfo">
    <p>&copy; 2025 241 Runners Awareness. All rights reserved.</p>
  </footer>

  <script>
    // Google OAuth handling
    function handleCredentialResponse(response) {
      const responsePayload = decodeJwtResponse(response.credential);
      
      console.log("ID: " + responsePayload.sub);
      console.log('Full Name: ' + responsePayload.name);
      console.log('Email: ' + responsePayload.email);
      
      // Send to backend for registration
      registerWithGoogle(response.credential);
    }

    function decodeJwtResponse(token) {
      var base64Url = token.split('.')[1];
      var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    }

    async function registerWithGoogle(idToken) {
      try {
        const response = await fetch('http://localhost:5113/api/auth/google-register', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ idToken })
        });

        const data = await response.json();

        if (response.ok) {
          localStorage.setItem('user', JSON.stringify(data));
          showMessage('Registration successful! Redirecting...', 'success');
                  setTimeout(() => {
          window.location.href = 'index.html';
        }, 1500);
        } else {
          showMessage(data.message || 'Registration failed', 'error');
        }
      } catch (error) {
        console.error('Registration error:', error);
        showMessage('Network error. Please try again.', 'error');
      }
    }

    // Role-based field visibility
    document.getElementById('role').addEventListener('change', function() {
      const role = this.value;
      const individualFields = document.getElementById('individualFields');
      const roleSpecificFields = document.getElementById('roleSpecificFields');
      const additionalFields = document.getElementById('additionalFields');
      const relationshipFields = document.getElementById('relationshipFields');
      const therapistFields = document.getElementById('therapistFields');
      const caregiverFields = document.getElementById('caregiverFields');
      
      // Hide all conditional fields first
      individualFields.style.display = 'none';
      roleSpecificFields.style.display = 'none';
      additionalFields.style.display = 'none';
      relationshipFields.style.display = 'none';
      therapistFields.style.display = 'none';
      caregiverFields.style.display = 'none';
      
      // Show relevant fields based on role
      if (role === 'parent' || role === 'caregiver' || role === 'adoptive_parent') {
        individualFields.style.display = 'block';
        relationshipFields.style.display = 'block';
        additionalFields.style.display = 'block';
        
        if (role === 'caregiver') {
          caregiverFields.style.display = 'block';
        }
      } else if (role === 'therapist') {
        individualFields.style.display = 'block';
        therapistFields.style.display = 'block';
        additionalFields.style.display = 'block';
      } else if (role === 'user') {
        additionalFields.style.display = 'block';
      }
    });

    // Traditional registration form handling
    document.getElementById('signupForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      const userData = Object.fromEntries(formData.entries());
      
      // Validate passwords match
      if (userData.password !== userData.confirmPassword) {
        showMessage('Passwords do not match', 'error');
        return;
      }
      
      // Map form fields to backend schema
      const registrationData = {
        email: userData.email,
        password: userData.password,
        fullName: userData.fullName,
        phoneNumber: userData.phone,
        role: userData.role,
        // Role-specific fields
        relationshipToRunner: userData.relationshipToRunner,
        licenseNumber: userData.licenseNumber,
        organization: userData.organization,
        credentials: userData.credentials,
        specialization: userData.specialization,
        yearsOfExperience: userData.yearsOfExperience,
        // Common fields
        address: userData.address,
        city: userData.city,
        state: userData.state,
        zipCode: userData.zipCode,
        emergencyContactName: userData.emergencyContactName,
        emergencyContactPhone: userData.emergencyContactPhone,
        emergencyContactRelationship: userData.emergencyContactRelationship
      };
      
      // Use universal authentication handler
      await handleRegister(registrationData);
    });

    function showMessage(message, type) {
      const messageDiv = document.getElementById('message');
      messageDiv.textContent = message;
      messageDiv.className = `message ${type}`;
      messageDiv.style.display = 'block';
      
      setTimeout(() => {
        messageDiv.style.display = 'none';
      }, 5000);
    }

    // Sticky navbar scroll effect
    window.addEventListener('scroll', function() {
      const header = document.querySelector('header');
      if (window.scrollY > 50) {
        header.classList.add('scrolled');
      } else {
        header.classList.remove('scrolled');
      }
    });

    // Hamburger menu functionality
    const hamburger = document.querySelector('.hamburger');
    const nav = document.querySelector('nav');
    
    hamburger.addEventListener('click', function() {
      const isExpanded = hamburger.getAttribute('aria-expanded') === 'true';
      hamburger.setAttribute('aria-expanded', !isExpanded);
      hamburger.classList.toggle('active');
      nav.classList.toggle('active');
    });
    
    // Close menu when clicking on a link
    document.querySelectorAll('nav a').forEach(link => {
      link.addEventListener('click', () => {
        hamburger.classList.remove('active');
        nav.classList.remove('active');
      });
    });
    
    // Close menu when clicking outside
    document.addEventListener('click', function(e) {
      if (!hamburger.contains(e.target) && !nav.contains(e.target)) {
        hamburger.classList.remove('active');
        nav.classList.remove('active');
      }
    });

    // Dark mode toggle functionality
    const themeToggle = document.getElementById('theme-toggle');
    const body = document.body;
    
    // Check for saved theme preference or default to light mode
    const currentTheme = localStorage.getItem('theme') || 'light';
    if (currentTheme === 'dark') {
      body.classList.add('dark-mode');
      themeToggle.textContent = 'üåô';
      themeToggle.setAttribute('aria-pressed', 'true');
    }
    
    // Theme toggle click handler
    themeToggle.addEventListener('click', function() {
      body.classList.toggle('dark-mode');
      
      if (body.classList.contains('dark-mode')) {
        localStorage.setItem('theme', 'dark');
        themeToggle.textContent = 'üåô';
        themeToggle.setAttribute('aria-pressed', 'true');
      } else {
        localStorage.setItem('theme', 'light');
        themeToggle.textContent = '‚òÄÔ∏è';
        themeToggle.setAttribute('aria-pressed', 'false');
      }
    });
  </script>
</body>
</html> 